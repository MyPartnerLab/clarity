<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Secure Checkout — The Clarity Circle</title>
  <meta name="description" content="Join The Clarity Circle — 14‑day free trial, $97/year after">

  <!-- Bootstrap CSS (for grid basics + resets) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Google Font + FontAwesome + Stripe.js -->
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet"/>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <script src="https://js.stripe.com/v3"></script>

  <style>
    :root {
      --brand-primary: #800f2f;
      --brand-accent:  #c9184a;
      --bg-summary:   #f4e8de;
      --radius:       0.75rem;
      --gap:          1.5rem;
      --transition:   .3s ease;
    }
    body {
      margin:0;
      padding:2rem 0;
      font-family:'Lato', sans-serif;
      background:#fdf8f5;
    }

    /* ==== Wrapper & columns ==== */
    .checkout-wrapper {
      display:flex;
      flex-wrap:wrap;
      gap:var(--gap);
      max-width:1000px;
      margin:0 auto;
    }
    .checkout-form {
      flex:1 1 60%;
      background:#fff;
      border-radius:var(--radius) 0 0 var(--radius);
      box-shadow:0 4px 12px rgba(0,0,0,0.05);
      padding:2rem;
    }
    .checkout-summary {
      flex:1 1 40%;
      background:var(--bg-summary);
      border-radius: 0 var(--radius) var(--radius) 0;
      box-shadow:0 4px 12px rgba(0,0,0,0.05);
      padding:2rem;
    }

    /* Force side‑by‑side only on >=768px */
    @media (max-width:767px) {
      .checkout-wrapper { flex-direction:column; }
      .checkout-form,
      .checkout-summary { border-radius: var(--radius); }
    }

    /* ==== Headings & spacing ==== */
    .checkout-form h2,
    .checkout-summary h2 { color:var(--brand-primary); font-weight:700; margin-bottom:1rem; }
    label { font-weight:600; margin-top:1rem; }

    /* ==== Plan cards ==== */
    .plan-card {
      border:2px solid #ddd;
      border-radius:var(--radius);
      padding:1rem 1.25rem;
      cursor:pointer;
      transition:var(--transition);
      margin-bottom:1rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .plan-card.active {
      border-color:var(--brand-primary);
      background:#fff;
      box-shadow:0 0 0 3px rgba(128,15,47,.25);
    }
    .plan-card span.price { font-size:1.2rem; font-weight:700; }

    /* ==== Stripe card element ==== */
    #card-element { border:1px solid #ccc; padding:.75rem; border-radius:var(--radius); }
    button#submit { margin-top:1.5rem; width:100%; background:var(--brand-primary); color:#fff; border:none; padding:.75rem 1rem; border-radius:var(--radius); font-weight:700; transition:var(--transition); }
    button#submit:hover { background:var(--brand-accent); }
  </style>
</head>
<body>
  <div class="checkout-wrapper">
    <!-- ========= Left column: form ========= -->
    <form class="checkout-form" id="checkout-form">
      <h2>Secure Your Spot</h2>

      <!-- Plan selector -->
      <div id="plan-options">
        <div class="plan-card active" data-plan="lifetime" data-amount="9700" data-desc="Clarity Circle – Founding Member Plan (lifetime access)">
          <div>
            <strong>Founding Member – Lifetime</strong><br><small>One‑time $97</small>
          </div>
          <span class="price">$97</span>
        </div>
        <div class="plan-card" data-plan="monthly" data-amount="1700" data-desc="Clarity Circle – Monthly Plan (monthly)">
          <div>
            <strong>Monthly Plan</strong><br><small>$17 / month</small>
          </div>
          <span class="price">$17</span>
        </div>
      </div>

      <!-- Contact info -->
      <div class="form-row">
        <div class="col">
          <label>First Name</label>
          <input type="text" id="firstName" class="form-control" required />
        </div>
        <div class="col">
          <label>Last Name</label>
          <input type="text" id="lastName" class="form-control" required />
        </div>
      </div>
      <label>Email</label>
      <input type="email" id="email" class="form-control" required />

      <!-- Stripe Card Element -->
      <label class="mt-3">Card Details</label>
      <div id="card-element"></div>

      <button id="submit" type="submit">Complete Checkout</button>
      <p class="text-center mt-2" style="font-size:.8rem;color:#666"><i class="fas fa-lock"></i> Payments secured with 256‑bit SSL • PCI‑DSS Level 1</p>
    </form>

    <!-- ========= Right column: summary ========= -->
    <aside class="checkout-summary" id="summary">
      <h2>Order Summary</h2>
      <p id="summary-desc">Clarity Circle – Founding Member Plan <em>(lifetime access)</em></p>
      <p style="font-style:italic;opacity:.7">Total Value: $2500+</p>
      <hr>
      <p><strong>Due Today:</strong> <span id="due-today">$97</span></p>
    </aside>
  </div>

  <!-- ========= Scripts ========= -->
  <script>
    // == Stripe publishable key ==
    const stripe = Stripe('pk_test_51REdLuE8SHAdzYaCRQaHpLF10cTJq1FWcg5P39UAzp2W4tWUJ8S2BlWrqH6x7lYJIBhNnzkga48YObl5HphE9eBT001D6w1Oev');
    const elements = stripe.elements();
    const card = elements.create('card');
    card.mount('#card-element');

    // ===== Plan selection logic =====
    let selectedPlan = {
      plan: 'lifetime',
      amount: 9700,
      desc: 'Clarity Circle – Founding Member Plan (lifetime access)'
    };

    document.querySelectorAll('.plan-card').forEach(cardEl => {
      cardEl.addEventListener('click', () => {
        document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('active'));
        cardEl.classList.add('active');
        selectedPlan = {
          plan: cardEl.dataset.plan,
          amount: parseInt(cardEl.dataset.amount),
          desc: cardEl.dataset.desc
        };
        // update summary UI
        document.getElementById('summary-desc').innerHTML = cardEl.dataset.desc.replace('(', '(<em>').replace(')', '</em>');
        document.getElementById('due-today').textContent = `$${(selectedPlan.amount/100).toFixed(0)}`;
        document.getElementById('submit').textContent = selectedPlan.plan === 'lifetime' ? 'Complete Checkout' : 'Start My Monthly Plan';
      });
    });

    // ===== Form submit =====
    document.getElementById('checkout-form').addEventListener('submit', async e => {
      e.preventDefault();
      document.getElementById('submit').disabled = true;

      // create PaymentIntent OR Subscription on the fly with selected amount & plan
      const res = await fetch('/api/create-payment-intent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          plan: selectedPlan.plan,
          amount: selectedPlan.amount,
          email: document.getElementById('email').value,
          firstName: document.getElementById('firstName').value
        })
      });
      const { clientSecret, error: backendError } = await res.json();
      if (backendError) {
        alert(backendError);
        document.getElementById('submit').disabled = false;
        return;
      }

      const { error } = await stripe.confirmCardPayment(clientSecret, {
        payment_method: {
          card,
          billing_details: {
            name: `${document.getElementById('firstName').value} ${document.getElementById('lastName').value}`,
            email: document.getElementById('email').value
          }
        }
      });

      if (error) {
        alert(error.message);
        document.getElementById('submit').disabled = false;
      } else {
        window.location.href = '/thank-you';
      }
    });
  </script>
</body>
</html>
