<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clarity Circle Checkout</title>
  <meta name="description" content="Join The Clarity Circle — free 14-day trial" />

  <!-- Bootstrap / Fonts / Stripe.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet"/>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <script src="https://js.stripe.com/v3"></script>

  <style>
    :root { --brand:#800f2f; --accent:#c9184a; --form-bg:#fff; --summary-bg:#f4e8de;
            --radius:.75rem; --gap:1.5rem; --hl:#ffeb86; }
    body{margin:0;padding:3rem 0;font-family:'Lato',sans-serif;background:#fdf8f5;}
    .checkout-wrapper{max-width:1100px;margin:0 auto;display:flex;gap:var(--gap);}
    @media(max-width:767px){.checkout-wrapper{flex-direction:column;}}

    /* ========== FORM PANEL ========== */
    .checkout-form{flex:0 0 60%;background:var(--form-bg);border-radius:var(--radius);
      box-shadow:0 6px 16px rgba(0,0,0,.06);padding:2.25rem;}
    .plan-picker{display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1.5rem;}
    @media(max-width:575px){.plan-picker{flex-direction:column;}}
    .single-plan{position:relative;border:1px solid #d7d7d7;border-radius:var(--radius);
      background:#fff;display:flex;flex-direction:column;align-items:center;padding:1.25rem;
      cursor:pointer;transition:border .15s;z-index:0;}
    .single-plan:hover{border-color:var(--brand);}
    .single-plan input{display:none;}
    .single-plan.selected{border:2px solid var(--brand);}
    .single-plan .plan-badge{background:var(--summary-bg);color:var(--brand);font-size:.75rem;
      font-weight:700;border-radius:999px;padding:.1rem .4rem;margin-bottom:.25rem;text-align:center;}
    .single-plan .plan-title{font-weight:700;text-align:center;margin-top:.25rem;}
    .single-plan .plan-sub{font-style:italic;opacity:.75;font-size:.85rem;text-align:center;
      margin-top:.1rem;line-height:1.2;}
    .single-plan .price{font-size:1.3rem;font-weight:700;color:var(--brand);margin-top:.5rem;}

    h3{display:inline-block;vertical-align:middle;font-size:1.25em;font-weight:700;color:var(--brand);}
    .checkout-form .form-row,.checkout-form input[type="email"],
    .checkout-form .payment-label,.checkout-form .terms{margin-bottom:0.5rem;}
    input.form-control{border-radius:var(--radius);padding:1rem;min-height:2.8rem;font-size:1rem;}

    /* ========== CARDS ========== */
    .card-section{display:flex;align-items:center;justify-content:space-between;}
    .card-logos img{height:18px;margin-left:4px;}
    #card-element{border:1px solid #ccc;border-radius:var(--radius);padding:1rem;margin:.5rem 0;}
    #card-errors{color:#dc3545;font-size:.875rem;margin-top:.5rem;}

    .secure-note{display:flex;justify-content:center;align-items:center;font-size:.85rem;opacity:.7;margin-top:.75rem;}
    .secure-note img{width:16px;margin-right:6px;}
    #submit{width:100%;background:var(--brand);color:#fff;border:none;border-radius:var(--radius);
      padding:.85rem;font-weight:700;transition:background .25s;position:relative;z-index:2;}
    #submit:hover{background:var(--accent);}
    .terms{position:relative;z-index:2;}

    /* ========== SUMMARY PANEL ========== */
    .checkout-summary{flex:0 0 40%;display:flex;flex-direction:column;align-items:center;}
    .summary-mockup{width:100%;max-width:480px;margin-bottom:1.5rem;}
    .summary-box{background:var(--summary-bg);border-radius:var(--radius);
      box-shadow:0 6px 16px rgba(0,0,0,.06);padding:2rem;width:100%;text-align:left;}
    .summary-box h2{margin:0 0 1rem;font-size:2em;font-weight:700;color:var(--brand);}
    .benefits{list-style:none;padding:0;margin:0 0 1.5rem;width:100%;}
    .benefits li{display:flex;justify-content:space-between;margin-bottom:.5rem;font-size:1rem;}
    .benefits li img{width:18px;margin-right:.5rem;}

    .trial-badge{background:var(--hl);color:#000;font-size:.65rem;font-weight:700;
      border-radius:4px;padding:1px 4px;margin-left:4px;white-space:nowrap;text-transform:uppercase;}
    .cross{text-decoration:line-through;opacity:.6;}

    .order-box{background:transparent!important;box-shadow:none!important;padding:0!important;width:100%;margin-top:1.5rem;}
    .order-box h4{font-size:1.25em;font-weight:700;color:var(--brand);margin-bottom:.5rem;}
    .order-row{display:flex;justify-content:space-between;font-size:1rem;line-height:1.2;}
    .order-row span:last-child{font-weight:700;}
    .order-note{margin-top:.25rem;font-style:italic;opacity:.75;line-height:1.2;font-size:0.8rem;}
    .order-total{display:flex;justify-content:space-between;margin-top:1rem;font-size:1.25em;font-weight:700;color:var(--brand);}
  </style>
</head>
<body>
  <div class="checkout-wrapper">
    <form id="checkout-form" class="checkout-form" novalidate>
      <!-- ===== PLAN PICKER ===== -->
      <div class="plan-picker">
        <!-- Lifetime -->
        <label class="single-plan flex-fill" id="plan-lifetime">
          <input type="radio" name="plan" value="lifetime" checked>
          <span class="plan-badge">Founding&nbsp;Member</span>
          <span class="plan-title">Lifetime Access</span>
          <span class="plan-sub">Includes 14-day free trial</span>
          <span class="price">Just $97</span>
        </label>

        <!-- Monthly -->
        <label class="single-plan flex-fill" id="plan-monthly">
          <input type="radio" name="plan" value="monthly">
          <span class="plan-badge">Monthly&nbsp;Subscription</span>
          <span class="plan-title">Monthly&nbsp;Access</span>
          <span class="plan-sub">Includes 14-day free trial</span>
          <span class="price">$17/mo</span>
        </label>
      </div>

      <!-- ===== Contact ===== -->
      <h3>Contact Info</h3>
      <div class="form-row">
        <div class="col"><label for="firstName">First Name</label>
          <input type="text" id="firstName" name="firstName" class="form-control" required></div>
        <div class="col"><label for="lastName">Last Name</label>
          <input type="text" id="lastName" name="lastName" class="form-control" required></div>
      </div>
      <label for="email">Email</label>
      <input type="email" id="email" name="email" class="form-control" required>

      <!-- ===== Card ===== -->
      <div class="card-section" style="margin-top:2rem;">
        <h3>Credit/Debit Card</h3>
        <div class="payment-label">
          <div class="card-logos">
            <img src="img/visa_creditcard.png" alt="Visa">
            <img src="img/mastercard_creditcard.png" alt="Mastercard">
            <img src="img/amex_creditcard.png" alt="AMEX">
            <img src="img/discover_creditcard.png" alt="Discover">
            <span class="more-text">and more…</span>
          </div>
        </div>
      </div>
      <div id="card-element"></div>
      <div id="card-errors" role="alert"></div>
      <div class="secure-note"><img src="img/lock.svg" alt="">All payments secured by 256-bit encryption.</div>

      <!-- ===== Terms & CTA ===== -->
      <div class="terms" style="margin-top:30px;">
        <input type="checkbox" name="agree" id="agree" required>
        <label for="agree">I agree to the <a href="https://www.mypartnerlab.co/" target="_blank">terms &amp; conditions</a></label>
      </div>
      <button id="submit" type="submit">Secure My Spot</button>
    </form>

    <!-- ===== SUMMARY ===== -->
    <aside class="checkout-summary">
      <img src="img/mockup1.png" class="summary-mockup" alt="Program preview">
      <div class="summary-box">
        <h2>Join the Clarity Circle</h2>
        <ul class="benefits">
          <li><span><img src="img/checkmark.svg" alt="">Research-Backed Tools &amp; Frameworks</span><span>($997+)</span></li>
          <li><span><img src="img/checkmark.svg" alt="">Unlimited Relationship Wellness Checkups</span><span>($300+)</span></li>
          <li><span><img src="img/checkmark.svg" alt="">Private Community Access</span><span>($497)</span></li>
          <li><span><img src="img/checkmark.svg" alt="">Live Q&amp;A Sessions</span><span>($997+)</span></li>
          <li><span><img src="img/checkmark.svg" alt="">Lifetime Access</span><span>(priceless)</span></li>
          <li><span><img src="img/checkmark.svg" alt="">30-Day Refund Policy</span></li>
        </ul>

        <div class="order-box">
          <h4>Order Summary</h4>
          <div class="order-row">
            <span>Clarity Circle Membership<span class="trial-badge">FREE 14-DAY TRIAL</span></span>
            <span id="order-price" class="cross">$97</span>
          </div>
          <div id="summary-note" class="order-note"></div>
          <div class="order-total"><strong>Due Today:</strong><span id="due-today">$0.00</span></div>
          <div id="due-note" class="order-note"></div>
        </div>
      </div>
    </aside>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ---------- Stripe init ---------- */
  const stripe   = Stripe('pk_test_51QxWEQ4CPqLwMoEaMeGjbC4sCuZ0tHbtGDBETBR7ah2RuWQjzHodG7XBYJB832CViz1ywgbUaaslnJTR47hOmUOf00oKjvV58V');
  const elements = stripe.elements();
  const card     = elements.create('card');
  card.mount('#card-element');

  const form   = document.getElementById('checkout-form');
  const btn    = document.getElementById('submit');
  const errors = document.getElementById('card-errors');

  card.on('change', e => { errors.textContent = e.error ? e.error.message : ''; });

  /* plan-picker visuals */
  function toggleSelected(el){
    document.querySelectorAll('.single-plan').forEach(p=>p.classList.remove('selected'));
    el.classList.add('selected');
  }
  document.querySelectorAll('.single-plan').forEach(label => {
    label.addEventListener('click', () => {
      label.querySelector('input').checked = true;
      toggleSelected(label);
      updateSummary(label.querySelector('input').value);
    });
  });
  toggleSelected(document.getElementById('plan-lifetime'));

  /* ===== dynamic summary ===== */
  const note      = document.getElementById('summary-note');
  const total     = document.getElementById('due-today');
  const priceEl   = document.getElementById('order-price');
  const dueLine   = document.getElementById('due-note');

  function fmtDate(date){
    return date.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  }
function updateSummary(plan){
  const trialEnd = new Date();
  trialEnd.setDate(trialEnd.getDate() + 14);

  /* text that used to be in note */
  const planLine = plan === 'monthly'
      ? '14-day free trial; monthly subscription'
      : '14-day free trial; one-time payment';

  /* text that used to be in dueLine */
  const dueLineTxt = `Your free trial will end on ${fmtDate(trialEnd)} and you will be billed ${priceEl.textContent} at that time.`;

  /* ---------- swap ---------- */
  note.textContent   = dueLineTxt;   // goes to the old note position

  /* update the crossed-out price */
  priceEl.textContent = plan === 'monthly' ? '$17/mo' : '$97';

  total.textContent = '$0.00';
}
  updateSummary('lifetime');

  /* ---------- Form submit (unchanged) ---------- */
  form.addEventListener('submit', async e => {
    e.preventDefault(); errors.textContent = '';
    if (!form.agree.checked) return alert('Please agree to the terms & conditions.');
    btn.disabled = true;

    const firstName = form.firstName.value.trim();
    const lastName  = form.lastName.value.trim();
    const email     = form.email.value.trim();
    const plan      = document.querySelector('input[name="plan"]:checked').value;

    /* STEP 1 — SetupIntent */
    const siResp = await fetch('/.netlify/functions/create-setup-intent',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ firstName, lastName, email })
    });
    const {clientSecret, customerId, error:siErr} = await siResp.json();
    if (siErr){ btn.disabled=false; return errors.textContent=siErr; }

    /* STEP 2 — confirm */
    const {error:confirmErr}=await stripe.confirmCardSetup(clientSecret,{
      payment_method:{ card, billing_details:{name:`${firstName} ${lastName}`,email} }
    });
    if(confirmErr){ btn.disabled=false; return errors.textContent=confirmErr.message;}

    /* STEP 3 — subscription */
    const subResp=await fetch('/.netlify/functions/start-subscription',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ customerId, plan })
    });
    const {error:subErr}=await subResp.json();
    if(subErr){ btn.disabled=false; return errors.textContent=subErr; }

    /* SUCCESS */
    window.parent.postMessage({type:'checkoutComplete',url:'https://mypartnerlab.co/checkout-thank-you'},'*');
  });

  /* iframe auto-resize */
  const reportHeight=()=>window.parent.postMessage({type:'checkoutHeight',height:document.body.scrollHeight},'*');
  window.addEventListener('load',reportHeight);
  new MutationObserver(reportHeight).observe(document.body,{childList:true,subtree:true});
});
</script>
</body>
</html>
